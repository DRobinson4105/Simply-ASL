import numpy as np
from math import floor
import matplotlib.pyplot as plt
import cv2
import json
# Full connection array for the entire skeleton based on the keypoints image

width = 960
height = 960

connections = [
    (4, 8), #Legs and abdomen
    (4, 10),
    (7, 9),
    (9, 11),
    (7, 13),
    (6, 12),
    (12, 14),
    (14, 16),
    (13, 15),
    (15, 17),
    (92, 93),  # Hands (example for the left hand, repeat for right hand)
    (93, 94),
    (94, 95),
    (95, 96),  # Wrist to Thumb
    (97, 98),
    (98, 99),
    (99, 100),  # Other Finger
    (101, 102),
    (102, 103),
    (103, 104),  # Middle Finger
    (105, 106),
    (106, 107),
    (107, 108),  # Other Other Finger
    (109, 110),
    (110, 111),
    (111, 112),  # Pinky
    (92, 109),
    (92, 105),
    (92, 101),
    (92, 97),
    (113, 114),
    (114, 115),
    (115, 116),
    (116, 117),
    (113, 118),
    (118, 119),
    (119, 120),
    (120, 121),
    (113, 122),
    (122, 123),
    (123, 124),
    (124, 125),
    (113, 126),
    (126, 127),
    (127, 128),
    (128, 129),
    (113, 130),
    (130, 131),
    (131, 132),
    (132, 133),
    (54, 53), # Face
    (53, 52),
    (52, 51),
    (51, 46),
    (46, 48),
    (48, 50),
    (50, 40),
    (40, 37),
    (37, 35),
    (35, 32),
    (32, 29),
    (29, 27),
    (27, 25),
    (25, 24),
    (24, 41),
    (41, 43),
    (43, 45),
    (45, 51),
    (17, 23), # Feet
    (23, 22),
    (23, 21),
    (16, 20),
    (20, 18),
    (20, 19)
]

def convertWidth(c, min_width, frame_width):
    return (floor(((c - min_width) / frame_width) * width))

def convertHeight(d, min_height, frame_height):
    return floor(((d - min_height) / frame_height) * height)

def generate_scene(keypoint_frame, keypoint_confidence):

    image = np.zeros((height + 150, width + 150, 3), np.uint8)

    #Used for coordinate shift for the image
    min_width, min_height = [min(k) for k in zip(*keypoint_frame)]
    max_width, max_height = [max(k) for k in zip(*keypoint_frame)]

    frame_width = max_width - min_width
    frame_height = max_height - min_height

    for count, (c, d) in enumerate(keypoint_frame):

        #Don't plot if low confidence
        if(keypoint_confidence[count] < 0.3):
            continue

        #the hands have a keypoint index at 92 and above, so mark them as yellow
        if(count >= 92):
            cv2.circle(image,(convertWidth(c, min_width, frame_width),
                              convertHeight(d, min_height, frame_height)),
                              3, (0,255,255), -1)

        else :
            cv2.circle(image,(convertWidth(c, min_width, frame_width),
                              convertHeight(d, min_height, frame_height)),
                              3, (255,255,255), -1)

    for i in range(len(connections)):

        #If there is a low confidence, don't connect the points (one would not be plotted anyway)
        if(keypoint_confidence[connections[i][0] - 1] < 0.3 or keypoint_confidence[connections[i][1] - 1] < 0.3):
            continue

        p1 = keypoint_frame[connections[i][0] - 1]
        p2 = keypoint_frame[connections[i][1] - 1]

        cv2.line(image, (convertWidth(p1[0], min_width, frame_width), convertHeight(p1[1], min_height, frame_height)),
                        (convertWidth(p2[0], min_width, frame_width), convertHeight(p2[1], min_height, frame_height)),
                        (20, 170, 170), 3)
    
    # Test if image shows
    # cv2.imwrite("heya.png", image)
    return image

def go(JSONS):
    # Videowriter(Outfile, Codec, Framerate, Size, isColor)
    video = cv2.VideoWriter("output.avi", cv2.VideoWriter_fourcc(*'MJPG'), 30,(1110, 1110), isColor=True)
    for _ in range(500):
        for jsn in JSONS:
            video.write(generate_scene(jsn['instance_info'][0]['keypoints'], jsn['instance_info'][0]['keypoint_scores']))

    return video

go([{
    "instance_info": [
        {
            "keypoints": [
                [
                    1479.9755192378934,
                    1168.6669878595603
                ],
                [
                    1592.4889506415138,
                    1054.4227917519124
                ],
                [
                    1322.8117248613526,
                    1057.6359125527388
                ],
                [
                    1758.188730076511,
                    1179.215531239819
                ],
                [
                    1090.8359128883235,
                    1204.0433438921673
                ],
                [
                    2095.7304522269915,
                    2052.6874026128767
                ],
                [
                    831.906134155618,
                    1859.3987710530264
                ],
                [
                    2426.6985353418086,
                    3045.6662143600333
                ],
                [
                    477.6870589519617,
                    2763.0183016858846
                ],
                [
                    2317.558492295483,
                    3578.9623869372936
                ],
                [
                    1071.1736603007207,
                    1946.9255483208626
                ],
                [
                    1744.4457631937048,
                    3553.2897448527465
                ],
                [
                    780.8577092228097,
                    3506.24525927013
                ],
                [
                    2155.6705976760904,
                    3868.567396899356
                ],
                [
                    969.5637378455262,
                    1846.713257233915
                ],
                [
                    2255.727516799561,
                    3840.6092351017633
                ],
                [
                    1101.6105502860437,
                    972.9788695835014
                ],
                [
                    1430.7275476734599,
                    1086.110015689465
                ],
                [
                    1781.3671649834096,
                    963.3811603975064
                ],
                [
                    1707.4152430180384,
                    1003.8001700919194
                ],
                [
                    1430.7546785262402,
                    1552.8357324671806
                ],
                [
                    1399.194357044878,
                    1659.6957818334595
                ],
                [
                    1021.9239038117621,
                    1550.7588947745226
                ],
                [
                    1123.218727590809,
                    1110.9292719036193
                ],
                [
                    1130.1738644949505,
                    1188.4038386261345
                ],
                [
                    1145.263497434391,
                    1263.4081497582147
                ],
                [
                    1169.963639996341,
                    1338.044415208551
                ],
                [
                    1205.0419287215236,
                    1405.4002213109065
                ],
                [
                    1263.1757305513147,
                    1463.8090828876575
                ],
                [
                    1327.5731895242607,
                    1501.1871700998909
                ],
                [
                    1389.540890238799,
                    1525.588111557914
                ],
                [
                    1462.253479608973,
                    1542.7226167194399
                ],
                [
                    1534.7502121065904,
                    1539.1902338185146
                ],
                [
                    1596.111395467531,
                    1495.9780818312774
                ],
                [
                    1656.3936514505895,
                    1441.942154368554
                ],
                [
                    1700.745575042929,
                    1383.7622963529006
                ],
                [
                    1724.222687320345,
                    1314.9647304149235
                ],
                [
                    1734.283354908062,
                    1238.5711864705763
                ],
                [
                    1740.7263374684953,
                    1156.5068631134195
                ],
                [
                    1734.5030196196062,
                    1075.2032902992678
                ],
                [
                    1197.8574885134026,
                    1024.4662262784354
                ],
                [
                    1243.200759186931,
                    989.0207057037628
                ],
                [
                    1298.3345788700594,
                    977.4014191551096
                ],
                [
                    1353.7999185349654,
                    980.0989551350622
                ],
                [
                    1405.29320615689,
                    990.3211654697707
                ],
                [
                    1515.096289166771,
                    989.8739133150261
                ],
                [
                    1557.6876822026125,
                    977.4465187147553
                ],
                [
                    1606.698853780062,
                    972.65093220579
                ],
                [
                    1651.8513755193517,
                    979.4685120153808
                ],
                [
                    1692.4048607275085,
                    1006.1772555775797
                ],
                [
                    1470.8724041603582,
                    1056.635046962926
                ],
                [
                    1477.7306791602764,
                    1100.887697486331
                ],
                [
                    1482.1062431408782,
                    1139.8675618123484
                ],
                [
                    1485.2573488973258,
                    1177.5520170476798
                ],
                [
                    1416.6740039233023,
                    1231.1258968479492
                ],
                [
                    1449.8615815966286,
                    1233.4357786419641
                ],
                [
                    1484.6352432028766,
                    1235.1822427488132
                ],
                [
                    1516.0516997675231,
                    1231.8089858304052
                ],
                [
                    1545.0754055089137,
                    1226.5476082172754
                ],
                [
                    1262.2856481881781,
                    1072.3423501177012
                ],
                [
                    1303.5033633095745,
                    1049.5684391500754
                ],
                [
                    1347.7174907285835,
                    1046.2010053632162
                ],
                [
                    1387.3700650314854,
                    1068.9388485670675
                ],
                [
                    1347.1751116629184,
                    1078.859444455452
                ],
                [
                    1301.7240315480794,
                    1080.8892217380453
                ],
                [
                    1533.8006322592869,
                    1068.0827293900297
                ],
                [
                    1568.7358890325322,
                    1046.0200723472472
                ],
                [
                    1610.3096370991825,
                    1045.366930898469
                ],
                [
                    1648.272720841681,
                    1062.8991321768685
                ],
                [
                    1611.3495341274515,
                    1075.5689591926248
                ],
                [
                    1570.221065232306,
                    1077.1233787977958
                ],
                [
                    1335.201718954204,
                    1325.2662066423427
                ],
                [
                    1402.0215584975203,
                    1301.1059150085148
                ],
                [
                    1463.3119398523027,
                    1292.7480574846559
                ],
                [
                    1487.7385129820536,
                    1292.4006898618795
                ],
                [
                    1512.913445467656,
                    1290.6910659750301
                ],
                [
                    1565.9447430552946,
                    1295.3537305934465
                ],
                [
                    1615.4466498821525,
                    1310.129748638442
                ],
                [
                    1580.5674397389926,
                    1332.183255045934
                ],
                [
                    1536.6043917031675,
                    1348.9850098332645
                ],
                [
                    1488.273871344587,
                    1355.8029461611136
                ],
                [
                    1433.696234143451,
                    1354.5384947391703
                ],
                [
                    1384.555477045486,
                    1344.4058893266556
                ],
                [
                    1349.588448615696,
                    1325.0666752572447
                ],
                [
                    1422.5184417930163,
                    1316.0529429779626
                ],
                [
                    1489.7150194060778,
                    1312.6662572051673
                ],
                [
                    1544.620606739942,
                    1309.1484915528226
                ],
                [
                    1603.0557038295547,
                    1311.2315088952873
                ],
                [
                    1546.8378399849053,
                    1317.8904380800386
                ],
                [
                    1487.0005061884476,
                    1321.6310276436748
                ],
                [
                    1418.0401851547422,
                    1325.4608656112468
                ],
                [
                    2237.994648628522,
                    3593.5116593701587
                ],
                [
                    2206.2379854494093,
                    3533.258647683848
                ],
                [
                    2185.308912428925,
                    3504.5261282297324
                ],
                [
                    2112.5315897959767,
                    3524.5213358939864
                ],
                [
                    1903.0284535726578,
                    3426.0557465927277
                ],
                [
                    2195.6943172852248,
                    3496.627347382844
                ],
                [
                    2186.2584922762285,
                    3511.5823375933896
                ],
                [
                    1788.274346915313,
                    3279.9243792244615
                ],
                [
                    1779.6535184444347,
                    3271.779363100669
                ],
                [
                    2200.008598857135,
                    3519.5652567491816
                ],
                [
                    2166.984877255204,
                    3525.7142459854776
                ],
                [
                    1823.154866003124,
                    3356.401823798874
                ],
                [
                    1816.6271590252372,
                    3332.5745202180806
                ],
                [
                    2200.186377339826,
                    3546.2130951089603
                ],
                [
                    2168.8630938353845,
                    3543.0612360288114
                ],
                [
                    1840.3379774204604,
                    3409.6288113340443
                ],
                [
                    1847.8291866569461,
                    3407.0445293207376
                ],
                [
                    2177.482851351548,
                    3740.64151553985
                ],
                [
                    2169.113459248759,
                    3753.731915260705
                ],
                [
                    2167.0657938336713,
                    3749.4513193755174
                ],
                [
                    2179.4924383767693,
                    3752.9665894000555
                ],
                [
                    1099.3423871946334,
                    1886.8787230271337
                ],
                [
                    1116.891765124501,
                    1727.2173689258157
                ],
                [
                    1149.724499802256,
                    1562.701543383242
                ],
                [
                    1221.2979503405713,
                    1468.9692093154963
                ],
                [
                    1268.0003815424088,
                    1378.4489859135128
                ],
                [
                    1373.605441064442,
                    1603.930146622015
                ],
                [
                    1503.3727858915572,
                    1550.0427684334854
                ],
                [
                    1583.6707095181691,
                    1519.0462392012278
                ],
                [
                    1650.3791697711258,
                    1464.2263280890152
                ],
                [
                    1425.1804782296117,
                    1673.8569247227088
                ],
                [
                    1546.4011284511207,
                    1602.274356992134
                ],
                [
                    1627.0077250255904,
                    1537.0324664812752
                ],
                [
                    1674.4109175959456,
                    1491.741456531251
                ],
                [
                    1436.8140213087654,
                    1735.3969673206411
                ],
                [
                    1534.9695198332297,
                    1651.5649076005702
                ],
                [
                    1600.4927902015816,
                    1585.4672544309324
                ],
                [
                    1649.0122745698754,
                    1523.0510087940916
                ],
                [
                    1425.6446776010816,
                    1783.8697838844914
                ],
                [
                    1476.0590378451234,
                    1715.6856670292277
                ],
                [
                    1538.6319469686068,
                    1647.4184814198343
                ],
                [
                    1591.526876322535,
                    1588.869151649405
                ]
            ],
            "keypoint_scores": [
                0.9946465492248535,
                1.0043268203735352,
                1.0047686100006104,
                1.0105550289154053,
                0.9904502630233765,
                0.7535310387611389,
                0.7308917045593262,
                0.6585982441902161,
                0.7634185552597046,
                0.3668350577354431,
                0.7907406091690063,
                0.422490656375885,
                0.4197135269641876,
                0.10784556716680527,
                0.057570621371269226,
                0.051399607211351395,
                0.06789621710777283,
                0.10390422493219376,
                0.07479839771986008,
                0.03438761830329895,
                0.043902378529310226,
                0.08490513265132904,
                0.0634358823299408,
                0.9684280753135681,
                1.0079619884490967,
                0.9896103739738464,
                1.029120922088623,
                1.01978600025177,
                0.9904484152793884,
                1.0434004068374634,
                0.9725251197814941,
                1.019614577293396,
                1.0558916330337524,
                1.030112624168396,
                1.038259506225586,
                1.025675654411316,
                1.0603604316711426,
                1.0285894870758057,
                1.0256505012512207,
                0.9653657674789429,
                0.9791322350502014,
                0.9776281118392944,
                0.9819585680961609,
                1.0084799528121948,
                1.0270813703536987,
                1.0174092054367065,
                1.0129985809326172,
                1.0160998106002808,
                1.0086145401000977,
                1.054677963256836,
                1.014938235282898,
                1.0180583000183105,
                1.0385470390319824,
                1.0413668155670166,
                0.9895729422569275,
                1.0116245746612549,
                1.0087662935256958,
                1.0344747304916382,
                1.033300518989563,
                1.0117011070251465,
                1.00099515914917,
                0.9958364367485046,
                0.9998323321342468,
                1.013779878616333,
                1.0161443948745728,
                1.0397851467132568,
                1.0402582883834839,
                1.0425515174865723,
                1.0133397579193115,
                1.0284340381622314,
                1.0365755558013916,
                1.048814058303833,
                0.9997138977050781,
                1.0276306867599487,
                1.0123792886734009,
                1.0082802772521973,
                1.001023769378662,
                1.03768789768219,
                0.9817476868629456,
                0.9807085394859314,
                1.0087159872055054,
                0.9927586913108826,
                1.0007052421569824,
                1.0218673944473267,
                0.9907140731811523,
                1.0032495260238647,
                0.9889113306999207,
                1.0254402160644531,
                1.008617877960205,
                1.0404316186904907,
                1.0321193933486938,
                0.25971877574920654,
                0.2544110417366028,
                0.19639675319194794,
                0.13012045621871948,
                0.10915340483188629,
                0.21611149609088898,
                0.11753322929143906,
                0.09595414996147156,
                0.09407971799373627,
                0.1741221845149994,
                0.11182371526956558,
                0.10623928904533386,
                0.09694784134626389,
                0.14163659512996674,
                0.1012980118393898,
                0.10687636584043503,
                0.09719956666231155,
                0.14028137922286987,
                0.11273196339607239,
                0.10453714430332184,
                0.1006099283695221,
                0.9734962582588196,
                1.0098636150360107,
                0.9122214913368225,
                0.9295758008956909,
                1.1004122495651245,
                0.942419171333313,
                1.0533190965652466,
                0.9275869727134705,
                0.9227952361106873,
                0.9652355313301086,
                1.0238878726959229,
                0.9710217118263245,
                1.0972929000854492,
                0.9904207587242126,
                0.9228904843330383,
                0.8348585367202759,
                0.8813555240631104,
                0.9929056763648987,
                0.8278098702430725,
                0.6811112761497498,
                0.6246556043624878
            ]
        }
    ]
}])